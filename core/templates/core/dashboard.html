{% extends 'core/base.html' %}
{% block content %}
<h2 class="mb-3">My Services</h2>
<form method="get" class="row g-2 mb-4">
    <div class="col-12 col-md-4">
        <label for="year" class="form-label">Year</label>
        <select name="year" id="year" class="form-select">
            <option value="" {% if not selected_year or selected_year == '' %}selected{% endif %}>All</option>
            {% for year in years %}
            <option value="{{ year }}" {% if year|stringformat:'s' == selected_year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-12 col-md-4">
        <label for="category" class="form-label">Category</label>
        <select name="category" id="category" class="form-select">
            <option value="">All</option>
            {% for category in categories %}
            <option value="{{ category.id }}" {% if category.id|stringformat:'s' == selected_category_id %}selected{% endif %}>{{ category.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-12 col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
    </div>
</form>

{% for status in status_list %}
    <h4 class="mt-4 mb-3">{{ status.label }} Payments</h4>
    <div class="row g-3">
        {% for item in service_status %}
            {% if item.status == status.key %}
            <div class="col-12 col-md-6">
                <div class="card shadow-sm mb-4" style="border-left: 5px solid #1976d2;">
                    <div class="card-body">
                        <h5 class="card-title">{{ item.category.name }} <span class="badge bg-primary ms-2">{{ item.year }}</span></h5>
                        <p class="card-text">{{ item.service.description }}</p>
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item"><strong>Due Amount:</strong> <span class="text-danger">{{ item.due_amount }}</span></li>
                            <li class="list-group-item"><strong>Due Date:</strong> {{ item.due_date }}</li>
                            <li class="list-group-item"><strong>Total Paid:</strong> <span class="text-success">{{ item.total_paid }}</span></li>
                            <li class="list-group-item"><strong>Remaining:</strong> <span class="badge bg-warning text-dark">{{ item.remaining }}</span></li>
                            <li class="list-group-item"><strong>Status:</strong> <span class="badge bg-{{ status.color }}">{{ status.label }}</span></li>
                        </ul>
                        <a href="{% url 'make_payment' %}?service={{ item.service.id }}" class="btn btn-primary w-100 mb-3 {% if item.status == 'full' %}disabled{% endif %}">Make Payment</a>
                        <h6 class="mt-3">Payment History</h6>
                        {% if item.payments %}
                        <ul class="list-group mb-2">
                            {% for payment in item.payments %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>{{ payment.payment_date|date:'M d, Y H:i' }}</span>
                                <span class="fw-bold">{{ payment.amount_paid }}</span>
                                <span class="badge {% if payment.status == 'full' %}bg-success{% else %}bg-warning text-dark{% endif %}">{{ payment.status|title }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <div class="text-muted">No payments yet.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
        {% if not service_status|dictsort:'status'|yesno:'true,false' %}
            <div class="text-muted ms-2">No {{ status.label|lower }} payments.</div>
        {% endif %}
    </div>
{% endfor %}
{% endblock %}
